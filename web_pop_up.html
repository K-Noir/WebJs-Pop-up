<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿå‡çº§ä¿æŠ¤ - å®Œæ•´æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 20px;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            font-size: 1.5em;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .status-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .status-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
            display: block;
        }

        .status-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .status-value.upgrading {
            color: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-value.ready {
            color: #27ae60;
        }

        .upgrade-progress {
            margin-top: 25px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .progress-bar-container {
            height: 12px;
            background: #ecf0f1;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-width: 180px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(41, 128, 185, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, #219653, #1e8449);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .test-actions {
            margin-top: 30px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .action-btn {
            background: #f8f9fa;
            border: 2px solid #dfe6e9;
            padding: 15px;
            border-radius: 10px;
            color: #2c3e50;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .browser-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #9b59b6;
        }

        .browser-info h3 {
            color: #9b59b6;
            margin-bottom: 15px;
        }

        .warning-alert {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #e17055;
        }

        .warning-alert h3 {
            color: #d63031;
            margin-bottom: 10px;
        }

        .instructions {
            margin-top: 40px;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .instructions h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 15px;
            padding-left: 10px;
        }

        /* å‡çº§æç¤ºæ¨ªå¹… */
        .upgrade-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 18px 30px;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .banner-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .banner-icon {
            font-size: 2rem;
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .banner-text h3 {
            margin-bottom: 5px;
            font-size: 1.3rem;
        }

        .banner-buttons {
            display: flex;
            gap: 10px;
        }

        .banner-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .banner-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* é¢„å‡çº§ç¡®è®¤æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 20000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            animation: modalSlideUp 0.4s ease;
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .modal-content {
            margin-bottom: 30px;
        }

        .modal-content ul {
            margin: 15px 0 15px 20px;
        }

        .modal-content li {
            margin-bottom: 10px;
            padding-left: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background: #3498db;
            color: white;
        }

        .modal-btn.confirm:hover {
            background: #2980b9;
        }

        .modal-btn.cancel {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .modal-btn.cancel:hover {
            background: #dfe6e9;
        }

        .completion-message {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #27ae60, #219653);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(39, 174, 96, 0.4);
            z-index: 10000;
            display: none;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            padding: 20px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<div class="main-container">
    <!-- å‡çº§æ¨ªå¹… -->
    <div class="upgrade-banner" id="upgradeBanner">
        <div class="banner-content">
            <div class="banner-icon">âš™ï¸</div>
            <div class="banner-text">
                <h3>ğŸš€ ç³»ç»Ÿæ­£åœ¨å‡çº§ä¸­...</h3>
                <p>è¯·ä¸è¦å…³é—­æˆ–åˆ·æ–°é¡µé¢ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å‡çº§å¤±è´¥å’Œæ•°æ®ä¸¢å¤±</p>
                <p>å‡çº§è¿›åº¦ï¼š<span id="bannerProgress">0%</span></p>
            </div>
        </div>
        <div class="banner-buttons">
            <button class="banner-btn" onclick="pauseUpgrade()">æš‚åœå‡çº§</button>
            <button class="banner-btn" onclick="showForceCloseConfirm()">å¼ºåˆ¶ç»“æŸ</button>
        </div>
    </div>

    <!-- é¢„å‡çº§ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="preUpgradeModal">
        <div class="modal">
            <h2>âš ï¸ ç¡®è®¤å¼€å§‹ç³»ç»Ÿå‡çº§</h2>
            <div class="modal-content">
                <p><strong>å‡çº§é¢„è®¡éœ€è¦ 2-3 åˆ†é’Ÿå®Œæˆ</strong></p>
                <ul>
                    <li>âœ… æ‚¨çš„å½“å‰æ•°æ®å·²è‡ªåŠ¨ä¿å­˜</li>
                    <li>âš ï¸ <strong>å‡çº§æœŸé—´è¯·ä¸è¦å…³é—­æµè§ˆå™¨çª—å£</strong></li>
                    <li>ğŸ”„ å‡çº§è¿‡ç¨‹ä¸å¯ä¸­æ–­ï¼Œå¦åˆ™éœ€è¦é‡æ–°å¼€å§‹</li>
                    <li>ğŸ“Š å‡çº§è¿›åº¦ä¼šå®æ—¶æ˜¾ç¤º</li>
                    <li>ğŸ”§ å‡çº§åå¯èƒ½éœ€è¦é‡æ–°ç™»å½•</li>
                </ul>
                <p style="margin-top: 15px; color: #e74c3c;">
                    <strong>æ³¨æ„ï¼š</strong>å¦‚æœæ‚¨åœ¨å‡çº§æœŸé—´å…³é—­é¡µé¢ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºæç¤ºï¼š
                    <em>"ç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"</em>ï¼ˆè¿™æ˜¯æµè§ˆå™¨é»˜è®¤æç¤ºï¼Œæ— æ³•æ›´æ”¹ï¼‰
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="hidePreUpgradeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmUpgrade()">ç¡®è®¤å¼€å§‹å‡çº§</button>
            </div>
        </div>
    </div>

    <!-- å¼ºåˆ¶å…³é—­ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="forceCloseModal" style="display: none;">
        <div class="modal">
            <h2>âš ï¸ è­¦å‘Šï¼šå¼ºåˆ¶ç»“æŸå‡çº§</h2>
            <div class="modal-content">
                <p>æ‚¨ç¡®å®šè¦å¼ºåˆ¶ç»“æŸç³»ç»Ÿå‡çº§å—ï¼Ÿ</p>
                <ul>
                    <li>âŒ å·²å®Œæˆçš„å‡çº§è¿›åº¦å°†ä¸¢å¤±</li>
                    <li>âš ï¸ å¯èƒ½å¯¼è‡´ç³»ç»ŸçŠ¶æ€ä¸ä¸€è‡´</li>
                    <li>ğŸ”„ ä¸‹æ¬¡éœ€è¦ä»å¤´å¼€å§‹å‡çº§</li>
                    <li>ğŸ“Š æœªä¿å­˜çš„æ•°æ®å¯èƒ½ä¼šä¸¢å¤±</li>
                </ul>
                <p style="margin-top: 15px; color: #e74c3c; font-weight: bold;">
                    å¼ºçƒˆå»ºè®®ç­‰å¾…å‡çº§å®Œæˆï¼
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="hideForceCloseModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="forceCompleteUpgrade()" style="background: #e74c3c;">å¼ºåˆ¶ç»“æŸ</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="header">
        <h1>ğŸ”§ ç³»ç»Ÿå‡çº§ä¿æŠ¤æ¼”ç¤º</h1>
        <p>æ¼”ç¤ºå¦‚ä½•åœ¨ç³»ç»Ÿå‡çº§æœŸé—´ä¿æŠ¤ç”¨æˆ·æ•°æ®å¹¶é˜²æ­¢æ„å¤–å…³é—­</p>
    </div>

    <div class="dashboard">
        <!-- ç³»ç»ŸçŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <h2><i>ğŸ“Š</i> ç³»ç»ŸçŠ¶æ€</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">å‡çº§çŠ¶æ€</span>
                    <span id="upgradeStatus" class="status-value ready">å‡†å¤‡å°±ç»ª</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ä¿æŠ¤çŠ¶æ€</span>
                    <span id="protectionStatus" class="status-value ready">æœªæ¿€æ´»</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å‡çº§è¿›åº¦</span>
                    <span id="progressPercent" class="status-value">0%</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æµè§ˆå™¨å…¼å®¹</span>
                    <span id="browserCompatible" class="status-value ready">æ£€æµ‹ä¸­...</span>
                </div>
            </div>

            <div class="upgrade-progress">
                <div class="progress-info">
                    <span>å‡çº§è¿›åº¦</span>
                    <span id="progressText">ç­‰å¾…å¼€å§‹</span>
                </div>
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="showPreUpgradeModal()" id="startBtn">
                    <span>ğŸš€</span> å¼€å§‹å‡çº§
                </button>
                <button class="btn btn-success" onclick="completeUpgrade()" id="completeBtn" disabled>
                    <span>âœ…</span> å®Œæˆå‡çº§
                </button>
                <button class="btn btn-danger" onclick="cancelUpgrade()" id="cancelBtn" disabled>
                    <span>âŒ</span> å–æ¶ˆå‡çº§
                </button>
                <button class="btn btn-secondary" onclick="resetDemo()" id="resetBtn">
                    <span>ğŸ”„</span> é‡ç½®æ¼”ç¤º
                </button>
            </div>
        </div>

        <!-- æµ‹è¯•æ“ä½œå¡ç‰‡ -->
        <div class="card">
            <h2><i>ğŸ§ª</i> æµ‹è¯•ä¿æŠ¤æ•ˆæœ</h2>
            <p>åœ¨å‡çº§æœŸé—´å°è¯•ä»¥ä¸‹æ“ä½œï¼Œè§‚å¯Ÿæµè§ˆå™¨ä¿æŠ¤æœºåˆ¶ï¼š</p>

            <div class="test-actions">
                <div class="action-buttons">
                    <button class="action-btn" onclick="simulateCloseTab()">
                        <span>âŒ</span> æ¨¡æ‹Ÿå…³é—­æ ‡ç­¾é¡µ
                    </button>
                    <button class="action-btn" onclick="simulateRefresh()">
                        <span>ğŸ”„</span> æ¨¡æ‹Ÿåˆ·æ–°é¡µé¢
                    </button>
                    <button class="action-btn" onclick="simulateNavigation()">
                        <span>ğŸ“</span> æ¨¡æ‹Ÿé¡µé¢è·³è½¬
                    </button>
                    <button class="action-btn" onclick="simulateBackButton()">
                        <span>ğŸ”™</span> æ¨¡æ‹Ÿåé€€æŒ‰é’®
                    </button>
                </div>
            </div>

            <div class="browser-info">
                <h3>ğŸ“Œ æµè§ˆå™¨æç¤ºè¯´æ˜</h3>
                <p id="browserPromptText">æµè§ˆå™¨æ£€æµ‹ä¸­...</p>
                <p style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;">
                    æ³¨æ„ï¼šç°ä»£æµè§ˆå™¨ä½¿ç”¨ç»Ÿä¸€æç¤ºæ–‡æœ¬ï¼Œæ— æ³•è‡ªå®šä¹‰ä¸º"ç³»ç»Ÿæ­£åœ¨å‡çº§"
                </p>
            </div>
        </div>
    </div>

    <!-- æµè§ˆå™¨é™åˆ¶è­¦å‘Š -->
    <div class="warning-alert">
        <h3>âš ï¸ é‡è¦é™åˆ¶è¯´æ˜</h3>
        <p>ç”±äºæµè§ˆå™¨å®‰å…¨ç­–ç•¥é™åˆ¶ï¼š</p>
        <ul>
            <li><strong>æ— æ³•è‡ªå®šä¹‰å…³é—­æç¤ºæ–‡æœ¬</strong> - æ‰€æœ‰ç½‘ç«™éƒ½æ˜¾ç¤ºç»Ÿä¸€çš„"ç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"</li>
            <li><strong>æ— æ³•å®Œå…¨é˜»æ­¢å…³é—­</strong> - ç”¨æˆ·å§‹ç»ˆå¯ä»¥é€‰æ‹©å¼ºåˆ¶å…³é—­</li>
            <li><strong>æç¤ºæ–‡æœ¬ç”±æµè§ˆå™¨å†³å®š</strong> - Chromeã€Firefoxã€Safari å„æœ‰ä¸åŒä½†éƒ½æ— æ³•ä¿®æ”¹</li>
        </ul>
        <p style="margin-top: 10px;">æœ¬æ¼”ç¤ºé€šè¿‡é¡µé¢å†…æ˜æ˜¾æç¤º + è‡ªåŠ¨ä¿å­˜æœºåˆ¶æä¾›æœ€ä½³ç”¨æˆ·ä½“éªŒã€‚</p>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div class="instructions">
        <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
        <ol>
            <li><strong>ç‚¹å‡»"å¼€å§‹å‡çº§"æŒ‰é’®</strong> - ç³»ç»Ÿä¼šå…ˆæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œè¯´æ˜å‡çº§æ³¨æ„äº‹é¡¹</li>
            <li><strong>è§‚å¯Ÿä¿æŠ¤æœºåˆ¶æ¿€æ´»</strong> - å‡çº§å¼€å§‹åï¼Œé¡¶éƒ¨ä¼šå‡ºç°æ˜æ˜¾æ¨ªå¹…æç¤ºï¼Œbeforeunload äº‹ä»¶ç›‘å¬æ¿€æ´»</li>
            <li><strong>æµ‹è¯•ä¿æŠ¤æ•ˆæœ</strong> - åœ¨å‡çº§æœŸé—´ï¼Œä½¿ç”¨å³ä¾§çš„æµ‹è¯•æŒ‰é’®æ¨¡æ‹Ÿå„ç§ç¦»å¼€é¡µé¢çš„æ“ä½œ</li>
            <li><strong>æŸ¥çœ‹æµè§ˆå™¨æç¤º</strong> - å°è¯•å…³é—­æ—¶ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºé»˜è®¤çš„ç¦»å¼€ç¡®è®¤å¯¹è¯æ¡†</li>
            <li><strong>å®Œæˆæˆ–å–æ¶ˆå‡çº§</strong> - å‡çº§å®Œæˆåä¿æŠ¤è‡ªåŠ¨è§£é™¤ï¼Œæˆ–æ‰‹åŠ¨å–æ¶ˆ/å®Œæˆå‡çº§</li>
            <li><strong>é‡ç½®æ¼”ç¤º</strong> - ä»»ä½•æ—¶å€™éƒ½å¯ä»¥é‡ç½®æ¼”ç¤ºå›åˆ°åˆå§‹çŠ¶æ€</li>
        </ol>
        <p style="margin-top: 20px; color: #3498db; font-weight: bold;">
            ğŸ’¡ æœ€ä½³å®è·µï¼šé‡è¦æ“ä½œæœŸé—´é€šè¿‡æ˜æ˜¾çš„é¡µé¢å†…æç¤ºå‘ŠçŸ¥ç”¨æˆ·ï¼Œè€Œä¸æ˜¯ä¾èµ–æµè§ˆå™¨çš„é€šç”¨æç¤ºã€‚
        </p>
    </div>

    <!-- å®Œæˆæ¶ˆæ¯ -->
    <div class="completion-message" id="completionMessage">
        <h3>âœ… å‡çº§å®Œæˆï¼</h3>
        <p>ç³»ç»Ÿå‡çº§å·²æˆåŠŸå®Œæˆï¼Œç°åœ¨å¯ä»¥å®‰å…¨å…³é—­é¡µé¢ã€‚</p>
    </div>

    <div class="footer">
        <p>ç³»ç»Ÿå‡çº§ä¿æŠ¤æ¼”ç¤º | å±•ç¤º beforeunload äº‹ä»¶çš„å®é™…åº”ç”¨</p>
        <p>æ³¨æ„ï¼šéµå¾ªæµè§ˆå™¨å®‰å…¨è§„èŒƒï¼Œæä¾›æœ€ä½³ç”¨æˆ·ä½“éªŒ</p>
    </div>
</div>

<script>
    // ====================
    // çŠ¶æ€ç®¡ç†
    // ====================
    let isUpgrading = false;
    let upgradeProgress = 0;
    let upgradeInterval = null;
    let beforeUnloadHandler = null;
    let isProtectionActive = false;
    let autoSaveCompleted = false;

    // ====================
    // åˆå§‹åŒ–
    // ====================
    document.addEventListener('DOMContentLoaded', function() {
        initBeforeUnloadListener();
        checkBrowserCompatibility();
        updateUI();

        // æ¨¡æ‹Ÿä¸€äº›åˆå§‹æ•°æ®
        simulateUserData();
    });

    // ====================
    // Beforeunload äº‹ä»¶å¤„ç†
    // ====================
    function initBeforeUnloadListener() {
        // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (beforeUnloadHandler) {
            window.removeEventListener('beforeunload', beforeUnloadHandler);
        }

        // åˆ›å»ºæ–°çš„å¤„ç†å‡½æ•°
        beforeUnloadHandler = function(event) {
            if (shouldPreventUnload()) {
                // ç°ä»£æµè§ˆå™¨çš„æ ‡å‡†å†™æ³•
                event.preventDefault();
                event.returnValue = ''; // Chrome è¦æ±‚éç©º

                // è®°å½•è°ƒè¯•ä¿¡æ¯
                console.log('[beforeunload] é¡µé¢å³å°†å…³é—­ï¼Œæ˜¾ç¤ºæµè§ˆå™¨ç¡®è®¤å¯¹è¯æ¡†');
                console.log('[beforeunload] æç¤ºæ–‡æœ¬ç”±æµè§ˆå™¨å†³å®šï¼š"ç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"');

                // å°è¯•è‡ªåŠ¨ä¿å­˜ï¼ˆå¦‚æœå°šæœªä¿å­˜ï¼‰
                if (!autoSaveCompleted) {
                    autoSaveUserData();
                }
            }
        };

        // æ·»åŠ äº‹ä»¶ç›‘å¬
        window.addEventListener('beforeunload', beforeUnloadHandler);
        isProtectionActive = true;
        updateUI();
    }

    function shouldPreventUnload() {
        return isUpgrading && upgradeProgress < 100;
    }

    // ====================
    // å‡çº§æµç¨‹æ§åˆ¶
    // ====================
    function showPreUpgradeModal() {
        document.getElementById('preUpgradeModal').style.display = 'flex';
    }

    function hidePreUpgradeModal() {
        document.getElementById('preUpgradeModal').style.display = 'none';
    }

    function confirmUpgrade() {
        hidePreUpgradeModal();
        startUpgradeProcess();
    }

    async function startUpgradeProcess() {
        console.log('[ç³»ç»Ÿ] å¼€å§‹å‡çº§æµç¨‹...');

        // 1. è‡ªåŠ¨ä¿å­˜ç”¨æˆ·æ•°æ®
        await autoSaveUserData();

        // 2. å¼€å§‹å‡çº§
        isUpgrading = true;
        upgradeProgress = 0;

        // 3. æ˜¾ç¤ºå‡çº§æ¨ªå¹…
        showUpgradeBanner();

        // 4. æ›´æ–°UI
        updateUI();

        // 5. å¼€å§‹æ¨¡æ‹Ÿå‡çº§è¿›åº¦
        startUpgradeSimulation();

        console.log('[ç³»ç»Ÿ] å‡çº§å¼€å§‹ï¼Œä¿æŠ¤æœºåˆ¶å·²æ¿€æ´»');
        showToast('ä¿æŠ¤æœºåˆ¶å·²æ¿€æ´»ï¼Œå°è¯•å…³é—­é¡µé¢ä¼šæ”¶åˆ°æµè§ˆå™¨æç¤º');
    }

    function startUpgradeSimulation() {
        if (upgradeInterval) {
            clearInterval(upgradeInterval);
        }

        upgradeInterval = setInterval(function() {
            if (upgradeProgress < 100) {
                // æ¨¡æ‹Ÿä¸è§„åˆ™çš„è¿›åº¦å¢åŠ 
                let increment;
                if (upgradeProgress < 30) {
                    increment = Math.random() * 5 + 3; // åˆæœŸè¾ƒå¿«
                } else if (upgradeProgress < 70) {
                    increment = Math.random() * 3 + 2; // ä¸­æœŸä¸­ç­‰
                } else {
                    increment = Math.random() * 2 + 1; // åæœŸè¾ƒæ…¢
                }

                upgradeProgress = Math.min(upgradeProgress + increment, 100);

                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                updateProgress();

                // å¦‚æœå‡çº§å®Œæˆï¼Œè‡ªåŠ¨ç»“æŸ
                if (upgradeProgress >= 100) {
                    completeUpgrade();
                }
            }
        }, 500);
    }

    function pauseUpgrade() {
        if (upgradeInterval) {
            clearInterval(upgradeInterval);
            upgradeInterval = null;
            showToast('å‡çº§å·²æš‚åœï¼Œç‚¹å‡»"å®Œæˆå‡çº§"ç»§ç»­');
        }
    }

    function completeUpgrade() {
        if (!isUpgrading) return;

        console.log('[ç³»ç»Ÿ] å‡çº§å®Œæˆ');

        // åœæ­¢å‡çº§è®¡æ—¶å™¨
        if (upgradeInterval) {
            clearInterval(upgradeInterval);
            upgradeInterval = null;
        }

        // æ›´æ–°çŠ¶æ€
        isUpgrading = false;
        upgradeProgress = 100;

        // æ›´æ–°UI
        updateProgress();
        updateUI();

        // éšè—æ¨ªå¹…
        hideUpgradeBanner();

        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        showCompletionMessage();

        // æ˜¾ç¤ºæç¤º
        showToast('âœ… å‡çº§å®Œæˆï¼ä¿æŠ¤æœºåˆ¶å·²è§£é™¤');

        console.log('[ç³»ç»Ÿ] å‡çº§å®Œæˆï¼Œä¿æŠ¤æœºåˆ¶å·²è§£é™¤');
    }

    function cancelUpgrade() {
        if (!confirm('ç¡®å®šè¦å–æ¶ˆå‡çº§å—ï¼Ÿå·²å®Œæˆçš„è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
            return;
        }

        console.log('[ç³»ç»Ÿ] å‡çº§å–æ¶ˆ');

        // åœæ­¢å‡çº§è®¡æ—¶å™¨
        if (upgradeInterval) {
            clearInterval(upgradeInterval);
            upgradeInterval = null;
        }

        // é‡ç½®çŠ¶æ€
        isUpgrading = false;
        upgradeProgress = 0;

        // æ›´æ–°UI
        updateProgress();
        updateUI();

        // éšè—æ¨ªå¹…
        hideUpgradeBanner();

        showToast('å‡çº§å·²å–æ¶ˆ');
    }

    function resetDemo() {
        if (isUpgrading && !confirm('å‡çº§è¿›è¡Œä¸­ï¼Œç¡®å®šè¦é‡ç½®æ¼”ç¤ºå—ï¼Ÿ')) {
            return;
        }

        // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
        if (upgradeInterval) {
            clearInterval(upgradeInterval);
            upgradeInterval = null;
        }

        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        isUpgrading = false;
        upgradeProgress = 0;
        autoSaveCompleted = false;

        // æ›´æ–°UI
        updateProgress();
        updateUI();

        // éšè—æ‰€æœ‰æ¨¡æ€æ¡†å’Œæ¨ªå¹…
        hideUpgradeBanner();
        hidePreUpgradeModal();
        document.getElementById('forceCloseModal').style.display = 'none';
        document.getElementById('completionMessage').style.display = 'none';

        // é‡æ–°åˆå§‹åŒ–
        initBeforeUnloadListener();

        showToast('æ¼”ç¤ºå·²é‡ç½®');
    }

    // ====================
    // å¼ºåˆ¶å…³é—­ç›¸å…³
    // ====================
    function showForceCloseConfirm() {
        document.getElementById('forceCloseModal').style.display = 'flex';
    }

    function hideForceCloseModal() {
        document.getElementById('forceCloseModal').style.display = 'none';
    }

    function forceCompleteUpgrade() {
        hideForceCloseModal();

        // æ¨¡æ‹Ÿç´§æ€¥ä¿å­˜
        emergencySave();

        // å®Œæˆå‡çº§ï¼ˆå¼ºåˆ¶ï¼‰
        if (upgradeInterval) {
            clearInterval(upgradeInterval);
            upgradeInterval = null;
        }

        isUpgrading = false;
        upgradeProgress = 0;

        updateProgress();
        updateUI();
        hideUpgradeBanner();

        showToast('âš ï¸ å‡çº§å·²å¼ºåˆ¶ç»“æŸï¼Œå»ºè®®æ£€æŸ¥ç³»ç»ŸçŠ¶æ€');
    }

    // ====================
    // æ•°æ®ä¿å­˜æ¨¡æ‹Ÿ
    // ====================
    async function autoSaveUserData() {
        return new Promise(resolve => {
            setTimeout(() => {
                console.log('[ç³»ç»Ÿ] ç”¨æˆ·æ•°æ®å·²è‡ªåŠ¨ä¿å­˜');
                autoSaveCompleted = true;
                showToast('ğŸ’¾ æ•°æ®å·²è‡ªåŠ¨ä¿å­˜');
                resolve();
            }, 500);
        });
    }

    function emergencySave() {
        console.log('[ç³»ç»Ÿ] æ‰§è¡Œç´§æ€¥æ•°æ®ä¿å­˜...');
        showToast('ğŸš¨ æ­£åœ¨ç´§æ€¥ä¿å­˜æ•°æ®...');

        // æ¨¡æ‹Ÿç´§æ€¥ä¿å­˜
        setTimeout(() => {
            showToast('âœ… ç´§æ€¥ä¿å­˜å®Œæˆ');
        }, 1000);
    }

    function simulateUserData() {
        // æ¨¡æ‹Ÿç”¨æˆ·æœ‰ä¸€äº›æœªä¿å­˜çš„æ•°æ®
        setTimeout(() => {
            showToast('æ¨¡æ‹Ÿï¼šæ£€æµ‹åˆ°æœªä¿å­˜çš„è¡¨å•æ•°æ®');
        }, 2000);
    }

    // ====================
    // UI æ›´æ–°å‡½æ•°
    // ====================
    function updateUI() {
        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
        const statusElement = document.getElementById('upgradeStatus');
        const protectionElement = document.getElementById('protectionStatus');

        if (isUpgrading) {
            statusElement.textContent = 'å‡çº§ä¸­';
            statusElement.className = 'status-value upgrading';
            protectionElement.textContent = 'å·²æ¿€æ´»';
            protectionElement.className = 'status-value upgrading';

            // æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = true;
            document.getElementById('completeBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
        } else {
            statusElement.textContent = 'å‡†å¤‡å°±ç»ª';
            statusElement.className = 'status-value ready';
            protectionElement.textContent = isProtectionActive ? 'å°±ç»ª' : 'æœªæ¿€æ´»';
            protectionElement.className = isProtectionActive ? 'status-value ready' : 'status-value';

            // æŒ‰é’®çŠ¶æ€
            document.getElementById('startBtn').disabled = false;
            document.getElementById('completeBtn').disabled = true;
            document.getElementById('cancelBtn').disabled = true;
            document.getElementById('resetBtn').disabled = false;
        }
    }

    function updateProgress() {
        const progressPercent = Math.round(upgradeProgress);

        // æ›´æ–°è¿›åº¦æ¡
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = upgradeProgress + '%';

        // æ›´æ–°ç™¾åˆ†æ¯”æ–‡æœ¬
        document.getElementById('progressPercent').textContent = progressPercent + '%';
        document.getElementById('bannerProgress').textContent = progressPercent + '%';

        // æ›´æ–°è¿›åº¦æ–‡æœ¬
        const progressText = document.getElementById('progressText');
        if (upgradeProgress >= 100) {
            progressText.textContent = 'å‡çº§å®Œæˆ';
            progressBar.style.background = 'linear-gradient(90deg, #27ae60, #2ecc71)';
        } else if (upgradeProgress >= 70) {
            progressText.textContent = 'æœ€åé˜¶æ®µ...';
            progressBar.style.background = 'linear-gradient(90deg, #f39c12, #f1c40f)';
        } else if (upgradeProgress >= 30) {
            progressText.textContent = 'è¿›è¡Œä¸­...';
            progressBar.style.background = 'linear-gradient(90deg, #3498db, #2980b9)';
        } else {
            progressText.textContent = 'åˆå§‹åŒ–...';
            progressBar.style.background = 'linear-gradient(90deg, #3498db, #2ecc71)';
        }
    }

    function showUpgradeBanner() {
        const banner = document.getElementById('upgradeBanner');
        banner.style.display = 'flex';
        updateProgress();
    }

    function hideUpgradeBanner() {
        document.getElementById('upgradeBanner').style.display = 'none';
    }

    function showCompletionMessage() {
        const message = document.getElementById('completionMessage');
        message.style.display = 'block';

        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            message.style.display = 'none';
        }, 5000);
    }

    // ====================
    // æµ‹è¯•å‡½æ•°
    // ====================
    function simulateCloseTab() {
        console.log('[æµ‹è¯•] æ¨¡æ‹Ÿå…³é—­æ ‡ç­¾é¡µ');
        showToast('å°è¯•å…³é—­æ ‡ç­¾é¡µä¼šè§¦å‘æµè§ˆå™¨æç¤º');

        // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„ beforeunload äº‹ä»¶
        const event = new Event('beforeunload', { cancelable: true });
        event.preventDefault = function() {
            console.log('[æµ‹è¯•] äº‹ä»¶å·²è¢«é˜»æ­¢ï¼Œå°†æ˜¾ç¤ºæµè§ˆå™¨æç¤º');
        };
        event.returnValue = '';

        // è§¦å‘å¤„ç†å‡½æ•°
        if (beforeUnloadHandler) {
            beforeUnloadHandler(event);
        }

        if (isUpgrading) {
            alert('æµ‹è¯•ï¼šå¦‚æœæ‚¨ç°åœ¨å…³é—­æ ‡ç­¾é¡µï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºæç¤ºï¼š\n\n"ç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"\n\nï¼ˆè¿™æ˜¯æµè§ˆå™¨é»˜è®¤æç¤ºï¼Œæ— æ³•æ›´æ”¹ï¼‰');
        } else {
            alert('æµ‹è¯•ï¼šå½“å‰æ²¡æœ‰è¿›è¡Œå‡çº§ï¼Œå…³é—­æ ‡ç­¾é¡µä¸ä¼šæ”¶åˆ°æç¤ºã€‚');
        }
    }

    function simulateRefresh() {
        console.log('[æµ‹è¯•] æ¨¡æ‹Ÿåˆ·æ–°é¡µé¢');
        showToast('å°è¯•åˆ·æ–°é¡µé¢ä¼šè§¦å‘æµè§ˆå™¨æç¤º');

        if (isUpgrading) {
            alert('æµ‹è¯•ï¼šå¦‚æœæ‚¨ç°åœ¨åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºæç¤ºï¼š\n\n"ç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"');
        } else {
            alert('æµ‹è¯•ï¼šå½“å‰æ²¡æœ‰è¿›è¡Œå‡çº§ï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šæ”¶åˆ°æç¤ºã€‚');
        }
    }

    function simulateNavigation() {
        console.log('[æµ‹è¯•] æ¨¡æ‹Ÿé¡µé¢è·³è½¬');
        showToast('å°è¯•è·³è½¬é¡µé¢ä¼šè§¦å‘æµè§ˆå™¨æç¤º');

        if (isUpgrading) {
            alert('æµ‹è¯•ï¼šå¦‚æœæ‚¨ç°åœ¨è·³è½¬åˆ°å…¶ä»–é¡µé¢ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºæç¤ºï¼š\n\n"ç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"');

            // å®é™…å°è¯•è·³è½¬ï¼ˆä¼šè¢« beforeunload é˜»æ­¢ï¼‰
            setTimeout(() => {
                window.location.href = 'about:blank';
            }, 100);
        } else {
            alert('æµ‹è¯•ï¼šå½“å‰æ²¡æœ‰è¿›è¡Œå‡çº§ï¼Œå¯ä»¥æ­£å¸¸è·³è½¬é¡µé¢ã€‚');
        }
    }

    function simulateBackButton() {
        console.log('[æµ‹è¯•] æ¨¡æ‹Ÿåé€€æŒ‰é’®');
        showToast('å°è¯•ä½¿ç”¨åé€€æŒ‰é’®ä¼šè§¦å‘æµè§ˆå™¨æç¤º');

        if (isUpgrading) {
            alert('æµ‹è¯•ï¼šå¦‚æœæ‚¨ç‚¹å‡»æµè§ˆå™¨çš„åé€€æŒ‰é’®ï¼Œæµè§ˆå™¨ä¼šæ˜¾ç¤ºæç¤ºï¼š\n\n"ç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"');
        } else {
            alert('æµ‹è¯•ï¼šå½“å‰æ²¡æœ‰è¿›è¡Œå‡çº§ï¼Œå¯ä»¥ä½¿ç”¨åé€€æŒ‰é’®ã€‚');
        }
    }

    // ====================
    // æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹
    // ====================
    function checkBrowserCompatibility() {
        const compatibleElement = document.getElementById('browserCompatible');
        const promptElement = document.getElementById('browserPromptText');

        // æ£€æµ‹æµè§ˆå™¨ç±»å‹
        const userAgent = navigator.userAgent;
        let browserName = 'æœªçŸ¥æµè§ˆå™¨';
        let browserPrompt = '';

        if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
            browserName = 'Chrome';
            browserPrompt = 'æç¤ºæ–‡æœ¬ï¼š"è¦ç¦»å¼€å—ï¼Ÿç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"';
        } else if (userAgent.includes('Firefox')) {
            browserName = 'Firefox';
            browserPrompt = 'æç¤ºæ–‡æœ¬ï¼š"æ­¤é¡µé¢æƒ³è®©ä½ ç¡®è®¤æ˜¯å¦ç¦»å¼€ - ä½ è¾“å…¥çš„æ•°æ®å¯èƒ½ä¸ä¼šè¢«ä¿å­˜"';
        } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
            browserName = 'Safari';
            browserPrompt = 'æç¤ºæ–‡æœ¬ï¼š"Are you sure you want to leave this page? Your changes may not be saved."';
        } else if (userAgent.includes('Edg')) {
            browserName = 'Microsoft Edge';
            browserPrompt = 'æç¤ºæ–‡æœ¬ï¼š"è¦ç¦»å¼€å—ï¼Ÿç³»ç»Ÿå¯èƒ½ä¸ä¼šä¿å­˜æ‚¨æ‰€åšçš„æ›´æ”¹ã€‚"';
        }

        compatibleElement.textContent = browserName;
        promptElement.textContent = browserPrompt;

        // æ£€æŸ¥ beforeunload æ”¯æŒ
        const isBeforeUnloadSupported = 'onbeforeunload' in window;
        if (!isBeforeUnloadSupported) {
            compatibleElement.textContent = 'ä¸æ”¯æŒ';
            compatibleElement.className = 'status-value upgrading';
            showToast('å½“å‰æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ beforeunload äº‹ä»¶');
        }
    }

    // ====================
    // å·¥å…·å‡½æ•°
    // ====================
    function showToast(message) {
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æç¤º
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                z-index: 10001;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: fadeInOut 3s ease;
            `;

        document.body.appendChild(toast);

        // 3ç§’åç§»é™¤
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // æ·»åŠ  CSS åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                15% { opacity: 1; transform: translateX(-50%) translateY(0); }
                85% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
        `;
    document.head.appendChild(style);

    // ====================
    // å…¨å±€å¯¼å‡ºï¼ˆç”¨äºæŒ‰é’®çš„ onclickï¼‰
    // ====================
    window.startUpgrade = startUpgradeProcess;
    window.completeUpgrade = completeUpgrade;
    window.cancelUpgrade = cancelUpgrade;
    window.resetDemo = resetDemo;
    window.pauseUpgrade = pauseUpgrade;
    window.showForceCloseConfirm = showForceCloseConfirm;
    window.hideForceCloseModal = hideForceCloseModal;
    window.forceCompleteUpgrade = forceCompleteUpgrade;
    window.simulateCloseTab = simulateCloseTab;
    window.simulateRefresh = simulateRefresh;
    window.simulateNavigation = simulateNavigation;
    window.simulateBackButton = simulateBackButton;
    window.showPreUpgradeModal = showPreUpgradeModal;
    window.hidePreUpgradeModal = hidePreUpgradeModal;
    window.confirmUpgrade = confirmUpgrade;
</script>
</body>
</html>